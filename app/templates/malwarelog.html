{% extends "base.html" %}

{% block mainContent %}
<style>
  tfoot {
    display: table-row-group;
  }

  p {
    margin: 0;
  }

  #example td:hover {
    cursor: pointer;
  }

  #example tr.selected {
    background-color:  #F0BA11
  }

  th.dt-center {
    text-align: center;
  }

  .buttons-columnVisibility.active {
    background-color: grey;
  }
</style>

<!-- <div class="alert alert-danger alert-dismissible fade noneError" role="alert">
  Please choose logs to delete
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div> -->
<!-- $('#myAlert').on('closed.bs.alert', function () {
  // do somethingâ€¦
}) -->

<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Confirm Delete Log</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div>
          <p class="mainText">Are you sure you want to delete selected logs?</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button id="deleteButton" type="button" onlick="deleteLogs()" class="btn btn-primary">Delete</button>
      </div>
    </div>
  </div>
</div>

<div hidden>
  <form id="logDataForm">
    <input id="logData" type="text" name="logData">
  </form>
</div>

<div class="row">
  <div class="col-12">
    <div class="card card-secondary">
      <div class="card-header">
        <h3 class="card-title">Malware Files Detected</h3>
      </div>
      <!-- /.card-header -->
      <div class="card-body">
        <label for="datetimes" style="width: 23%; margin-bottom: 10px;">
          Search Date Time Range:
          <input id="dateRange" autocomplete="off" type="text" class="form-control" name="datetimes" style="width: 110%;"/>
        </label>
        <div class="row">
          <div class="col-6">
            <div id="hide-column" style="margin-bottom: 20px;"></div>
          </div>
          <div class="col-6">
            <button class="btn btn-danger float-right" onclick="deleteLog()" style="margin-bottom: 20px;">Delete Logs</button>
          </div>
        </div>
        <table id="example" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th></th>
              <th>MD5 Hash</th>
              <th>Honeynode Name</th>
              <th>Time</th>
              <th>Zipped File Password</th>
              <th>Download Malware</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <th></th>
              <th>MD5 Hash</th>
              <th>Honeynode Name</th>
              <th>Time</th>
              <th>Zipped File Password</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
  <!-- /.col -->
</div>
<!-- /.row -->

<div class="row toShow" hidden>
  <div class="col-12">
    <div class="card card-secondary">
      <div class="card-header">
        <h3 class="card-title">VirusTotal SHA Lookup</h3>
      </div>
      <!-- /.card-header -->
      <div class="card-body">
        <!-- Remove for now -->
        <!-- <div class="row">
          <div class="col-md-6">
            <div class="input-group mb-3">
              <input id="sha256-input" type="text" class="form-control" value="" disabled>
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button">Search</button>
              </div>
            </div>
          </div>
        </div> -->
        <div class="row">
          <div class="col-md-12 table-responsive">
            <table id="example2" class="table table-bordered">
              <tbody>
                <tr>
                  <th class="dt-center">MD5 Hash</th>
                  <th class="dt-center" style="width: 100px;">Positives</th>
                  <th class="dt-center">Vendor Name</th>
                  <th class="dt-center">Vendor Signatures</th>
                </tr>

                <tr>
                  <td id="md5-table" class="rowspan-change" rowspan="1">-</td>
                  <td id="total-vendors" class="rowspan-change" rowspan="1">-</td>
                  <td id="first-vendor-name">-</td>
                  <td id="first-vendor">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- /.col -->
</div>
<!-- /.row -->
{% endblock %}
{% block script %}
<!-- DataTables -->
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script>

  var CustomRenders = {
    name: function (data, type, row, meta) {
      return 'test'
    },
    download: function (data, type, row, meta) {
      return '<button type="button" onclick="downloadFile(\'' + data.replace("dionaea_malware_files/", "") + '\');" class="downloadButton btn btn-info btn-sm" title="Download Malware" style="margin:auto;display:block">Download File</button>'
    }
  };

  function downloadFile(path) {
    $.ajax({
      url: '/api/v1/virus_total_logs/dionaea_malware_file/' + path,
      type: 'GET',
      success: function (result) {
        window.location = "/api/v1/virus_total_logs/dionaea_malware_file/" + path;
      }
    });
  }

  function selectPersistedRows(table){
    if (!(sessionStorage.rowKeyStore))
      return;
    
    var rowKeys = JSON.parse(sessionStorage.rowKeyStore);
    for (var key in rowKeys)
    {
      $(table.row(key).node()).addClass('selected');
    }
  }

  function persistSelection( index ){
    var ss = sessionStorage;
    ss.rowKeyStore = "{}";
    var rowKeys = JSON.parse(ss.rowKeyStore);
    rowKeys[index] = true;
    ss.rowKeyStore = JSON.stringify(rowKeys);
  }

  function cleanTable() {
    $('#first-vendor').html("-");
    $('#first-vendor-name').html("-");
    var table = document.getElementById("example2");
    var rowCount = table.rows.length;

    for (var i = rowCount - 1; i > 1; i--) {
      table.deleteRow(i);
    }
  }

  function loadButton() {
    $('#hide-column').append(table.buttons().container());
  }

  var table, table2;
  var scanData;
  $(function () {
    sessionStorage.rowKeyStore = "{}"; //clear tablestate

    $('#example tfoot th').each(function () {
      var title = $(this).text();
      if (title != "") {
        $(this).html('<input style="width:100%" type="text" placeholder="Search ' + title + '" />');
      }
    });

    $('input[name="datetimes"]').daterangepicker({
      timePicker: true,
      alwaysShowCalendars: true,
      timePickerSeconds: true,
      startDate: moment().startOf('hour'),
      endDate: moment().startOf('hour').add(32, 'hour'),
      locale: {
        format: 'YYYY-MM-DD HH:mm:ss'
      },
      showDropdowns: true,
        opens: 'center',
        ranges: {
          'Today': [moment().startOf('day'), moment().endOf('day')],
          'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
          'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment().endOf('day')],
          'Last 30 Days': [moment().subtract(29, 'days').startOf('day'), moment().endOf('day')],
          'This Month': [moment().startOf('month').startOf('day'), moment().endOf('month').endOf('day')],
          'Last Month': [moment().subtract(1, 'month').startOf('month').startOf('day'), moment().subtract(1, 'month').endOf('month').endOf('day')]
        },
    });

    table = $('#example').DataTable({
      initComplete: function () {
        // Apply the search
        this.api().columns().every(function () {
          var that = this;

          $('input', this.footer()).on('keyup change clear', function () {
            if (that.search() !== this.value) {
              that
                .search(this.value)
                .draw();
            }
          });
        });
      },
      "ordering": true,
      "responsive": true,
      "autoWidth": false,
      "ajax": "/api/v1/virus_total_logs/datatables",
      'stateSave': true,
      "buttons": [
        "colvis"
      ],
      "columns": [
        { "data": "id" },
        { "data": "md5" },
        { "data": "honeynode_name" },
        { "data": "time_at_file_received" },
        { "data": "zipped_file_password" },
        { "data": "zipped_file_path", "render": CustomRenders.download },
      ],
      "columnDefs": [
        { //newline
          "orderable": false,
          'targets': 0,
          'checkboxes': {
            'selectRow': true
          }
        }, //newline
        { "className": "dt-center", "targets": "_all" },
        { "width": '13%', "targets": 5 }, //original 4
      ],
      'select': { //newline
        'style': 'multi'
      },
      "order": [[0, 'asc']] //newline
    });

    $('#example').on('click', 'tbody tr', function () {
      $(".toShow").prop("hidden", false);
      cleanTable();
      $('#example tbody > tr').removeClass('selected');
      $(this).addClass('selected');
      persistSelection( table.row(this).index() );
      var data = table.row(this).data();
      scanData = JSON.parse(data.scans);
      //$('#sha256-input').val(data.sha256);

      // Virus total api call here
      //$.ajax({
      //  url: '/api/v1/honeynodes/',
      //  type: 'DELETE',
      //  success: function(result) {
      //    console.log(result);
      //    location.reload();
      //  }
      //});

      // change accordingly to returned ajax data

      $('#md5-table').html(data.md5);
      $('#total-vendors').html(data.positives);

      var i = 0;
      for (var key in scanData) {

        if (scanData.hasOwnProperty(key)) {
          //console.log(key + " -> " + scanData[key]);
          if (scanData[key].result != null) {
            if ($('#first-vendor').html() == "-") {
              $('#first-vendor').html(scanData[key].result);
              $('#first-vendor-name').html(key);
              continue;
            }
            $('.rowspan-change').attr('rowspan', $('.rowspan-change').attr('rowspan') + 1);
            $('#example2 > tbody:last-child').append('<tr><td>' + key + '</td><td>' + scanData[key].result + '</td></tr>');
          }
        }
        i++;
      }
      //$('.rowspan-change').attr('rowspan', $('.rowspan-change').attr('rowspan') + 1);
      //$('#example2 > tbody:last-child').append('<tr><td>asd</td></tr>');

    });

  });

  var start_date;
  var end_date;
  var DateFilterFunction = (function (oSettings, aData, iDataIndex) {
     var dateStart = parseDateValue(start_date);
     var dateEnd = parseDateValue(end_date);
     var evalDate= parseDateValue(aData[3]);
       if ( ( isNaN( dateStart ) && isNaN( dateEnd ) ) ||
            ( isNaN( dateStart ) && evalDate <= dateEnd ) ||
            ( dateStart <= evalDate && isNaN( dateEnd ) ) ||
            ( dateStart <= evalDate && evalDate <= dateEnd ) )
       {
           return true;
       }
       return false;
 });

 function parseDateValue(rawDate) {
     var parsedDate= new Date(rawDate);
     return parsedDate;
 }    

 $( document ).ready(function() {

   $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('YYYY-MM-DD HH:mm:ss') + ' - ' + picker.endDate.format('YYYY-MM-DD HH:mm:ss'));
      start_date=picker.startDate.format('YYYY-MM-DD HH:mm:ss');
      console.log(start_date);
      end_date=picker.endDate.format('YYYY-MM-DD HH:mm:ss');
      $.fn.dataTableExt.afnFiltering.push(DateFilterFunction);
      $(".toShow").prop("hidden", true);
      $('#example tbody > tr').removeClass('selected');
      sessionStorage.rowKeyStore = "{}"; //clear tablestate
      table.draw();
   });

   $('#dateRange').on('cancel.daterangepicker', function(ev, picker) {
     $(this).val('');
     start_date='';
     end_date='';
     $.fn.dataTable.ext.search.splice($.fn.dataTable.ext.search.indexOf(DateFilterFunction, 1));
     table.draw();
   });
 });

  setInterval(function () {

    table.ajax.reload(function () {
      selectPersistedRows(table);
    }, false);

  }, 3000);

  setTimeout(loadButton, 200);
  $("*").mouseover(function () {
    loadButton();
  });
  
  $('#confirmModal').on('show.bs.modal', function (event) {
    $("#deleteButton").attr("onclick","confirmDelete()");
  })

  function deleteLog(token) {

    var rows_selected = table.column(0).checkboxes.selected();
    $('#logData').val(rows_selected.join(","));
    console.log($('#logData').val());

    if($('#logData').val()){
      $('#confirmModal').modal('show');
    }else{
      alert("Please select logs to delete.");
    }
  }

  function confirmDelete() {
    $('#confirmModal').modal('hide');
    $.ajax({
      type: "DELETE",
      url: "/api/v1/virus_total_logs",
      data: $('#logDataForm').serialize(),
      success: function(data){
        //$(".showSuccess").prop("hidden", false);
        alert("Logs Deleted");
      },
      error: function (jqXHR, textStatus, errorThrown) { 
        //$(".showError").prop("hidden", false);
        alert("Error");
      }
    });
    cleanTable();
    $(".toShow").prop("hidden", true);
    sessionStorage.rowKeyStore = "{}"; //clear tablestate
    table.ajax.reload(null, false);
  }
</script>
{% endblock %}