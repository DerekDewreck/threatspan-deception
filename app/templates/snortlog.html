{% extends "base.html" %}

{% block mainContent %}
<!-- Alert after adding node -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{category}} alert-dismissible fade show" role="alert">
  {{message}}
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
{% endfor %}
{% endif %}
{% endwith %}
<!-- alert end -->
<style>
  tfoot {
    display: table-row-group;
  }

  th.dt-center {
    text-align: center;
  }

  .buttons-columnVisibility.active {
    background-color: grey;
  }
</style>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Raw Log</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" id="target-command" rows="10" placeholder="" readonly
          style="height:auto; margin-top: 15px; margin-bottom: 0px; height: 500px; resize: none;">

          </textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div id="hide-column" style="margin-bottom: 20px;"></div>
    <table id="example" class="table table-bordered table-hover display">
      <thead>
        <tr>
          <th>Date</th>
          <th>Honeynode Name</th>
          <th>Attacker IP</th>
          <th>Honeynode IP</th>
          <th>Port Under Attack</th>
          <th>Signature</th>
          <th>Raw Logs</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th>Date</th>
          <th>Honeynode Name</th>
          <th>Attacker IP</th>
          <th>Honeynode IP</th>
          <th>Port Under Attack</th>
          <th>Signature</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
  <!-- /.col -->
</div>
<!-- /.row -->
{% endblock %}
{% block script %}
<script>
  function viewLog(input) {
    var obj = JSON.parse(input.replace(/'/g, '"'));
    var pretty = JSON.stringify(obj, null, "\t");
    $('#target-command').val(pretty);
  }

  function loadButton() {
    $('#hide-column').append(table.buttons().container());
  }

  var CustomRenders = {
    raw_logs: function (data, type, row, meta) {
      return '<button type="button" onclick="viewLog(`' + data.replace(/"/g, "'") + '`)" class="deletebutton btn btn-info btn-sm" data-toggle="modal" data-target="#exampleModal" title="View Raw Log" style="margin:auto;display:block">View Raw Log</button>'
    }
  };

  var table;
  $(function () {
    $('#example tfoot th').each(function () {
      var title = $(this).text();
      if (title != "") {
        $(this).html('<input style="width:100%" type="text" placeholder="Search ' + title + '" />');
      }
    });

    table = $('#example').DataTable({
      initComplete: function () {
        // Apply the search
        this.api().columns().every(function () {
          var that = this;

          $('input', this.footer()).on('keyup change clear', function () {
            if (that.search() !== this.value) {
              that
                .search(this.value)
                .draw();
            }
          });
        });
      },
      "ordering": true,
      "responsive": true,
      "autoWidth": false,
      "buttons": [
        "colvis"
      ],
      "ajax": "/api/v1/nids_logs/datatables",
      "columns": [
        { "data": "date" },
        { "data": "honeynode_name" },
        { "data": "source_ip" },
        { "data": "destination_ip" },
        { "data": "destination_port" },
        { "data": "signature" },
        { "data": "raw_logs", "render": CustomRenders.raw_logs }
      ],
      "columnDefs": [
        { "className": "dt-center", "targets": "_all" },
        { "width": '13%', "targets": 0 },
        { "width": '13%', "targets": 6 },
      ],
    });

  });

  setInterval(function () {
    table.ajax.reload(null, false);
  }, 3000);


  setTimeout(loadButton, 200);
  $("*").mouseover(function () {
    loadButton();
  });
</script>
{% endblock %}